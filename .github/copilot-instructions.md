# Copilot Instructions

- **Stack snapshot**: Next.js 16 (app router) with TRPC (v11) and SuperJSON; Drizzle ORM + Postgres; Tailwind/Shadcn UI; custom auth (no NextAuth); i18n/RTL helpers; runs under `npm` with Biome for lint/format.
- **Dev + quality commands**: `npm run dev` (Next dev with turbo), `npm run build`/`npm run preview`, `npm run typecheck`, `npm run check` (Biome read-only) or `npm run check:write`/`check:unsafe` to auto-fix. Seeds live in src/server/db/seed (run `npm run seed` or `seed:all`/`seed:clear`).
- **Database**: Drizzle config in [drizzle.config.ts](drizzle.config.ts) targets Postgres with schema entry point [src/server/db/schema.ts](src/server/db/schema.ts) (re-exports auth tables). Connection is cached in [src/server/db/index.ts](src/server/db/index.ts) for HMR. Migrations via `npm run db:generate|migrate|push|drop|studio`; docker DB via `npm run db:start` (compose uses env-driven host/port mapping) and `npm run db:reset` to rebuild.
- **Env wiring**: Server env is validated in [src/env/server.ts](src/env/server.ts); provide DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME and it derives DATABASE_URL. Also requires BASE_URL, OAUTH_REDIRECT_URL_BASE, JWT_SECRET_KEY (>=32 chars), OAuth client IDs/secrets, and email SMTP settings. Client env is empty by design [src/env/client.ts](src/env/client.ts).
- **Auth/session**: Auth actions in [src/auth/nextjs/actions/auth.ts](src/auth/nextjs/actions/auth.ts) handle sign-in/up/out and OAuth redirect creation. Sessions are HMAC-JWT cookies keyed `session-id` in [src/auth/core/session.ts](src/auth/core/session.ts); `getAuth()` (used in the app Providers) reads session and returns `{isAuthenticated, session}`. User fetch helpers live in [src/auth/nextjs/currentUser.ts](src/auth/nextjs/currentUser.ts) and use Drizzle.
- **Permissions**: Role definitions and permission matrix live in [src/auth/core/permissions.ts](src/auth/core/permissions.ts) with `hasPermission(user, resource, action, data?)`; roles are `admin` (unrestricted users) and `user` (self-only). UI menus (e.g., system sidebar) and protected procedures should rely on this helper.
- **Auth types/data**: Primary table definitions are under [src/auth/tables](src/auth/tables) (example: [users-table.ts](src/auth/tables/users-table.ts) with enum `user_role` and relations). Schema helpers for id/createdAt/updatedAt are in [src/auth/tables/schema-helpers.ts](src/auth/tables/schema-helpers.ts).
- **API layer**: tRPC setup is in [src/server/api/trpc.ts](src/server/api/trpc.ts) with `publicProcedure` and `protectedProcedure` (checks session cookie, throws UNAUTHORIZED). Root router is assembled in [src/server/api/root.ts](src/server/api/root.ts); add routers under src/server/api/routers and register them there.
- **App providers**: [src/app/providers/index.tsx](src/app/providers/index.tsx) wraps the tree with TranslationProvider, AuthProvider (`getAuth()`), ThemeProvider (next-themes), DirectionProvider, TRPCReactProvider, and Sonner Toaster. Root layout [src/app/layout.tsx](src/app/layout.tsx) sets fonts and RTL/LTR dir based on locale cookie.
- **i18n**: Custom i18n utilities in [src/lib/i18n](src/lib/i18n) expose `useTranslation`/`getT`; locale is persisted via cookie `LOCALE_COOKIE_NAME` through `setLocaleCookie` server action and drives RTL via DirectionProvider. Default locale falls back to `en`; Arabic switches `dir` to `rtl`.
- **UI conventions**: Components follow Shadcn patterns under [src/components/ui](src/components/ui); many primitives expect `className` merging via `cn` from [src/lib/utils.ts](src/lib/utils.ts). Sidebar/menu code uses `WrapWithTooltip` for truncated labels and respects collapsible rail vs full sidebar states.
- **Client auth usage**: In client components, call `useAuth()` from [src/auth/nextjs/components/auth-provider.tsx](src/auth/nextjs/components/auth-provider.tsx); it throws if provider is missing. For server actions requiring auth, use `getCurrentUser({withFullUser?, redirectIfNotFound?})` from currentUser helper or `protectedProcedure` in tRPC.
- **Internationalized UX**: When changing locale on the client, `useTranslation` updates document `dir` immediately and triggers `setLocaleCookie` in a transition to avoid UI stalls.
- **General patterns**: Avoid NextAuth assumptions; sessions are custom. Keep database access through Drizzle `db` from server/db/index. Prefer server actions for mutations (auth/i18n) and tRPC procedures for API; ensure new routes/components respect locale and permission checks.

If anything here is unclear or missing for your workflow, tell me what to add or adjust and Iâ€™ll update this guide.
